<!DOCTYPE html>
<html lang="es" itemscope itemtype="http://schema.org/Blog">
    <head>
        <!–– Made with Lockdown: https://github.com/fferegrino/lockdown ––>
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c"></meta>

  <link rel="shortcut icon" href="">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
  <script src="https://kit.fontawesome.com/0271495296.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <script src="/js/main.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/vs.min.css" integrity="sha512-aWjgJTbdG4imzxTxistV5TVNffcYGtIQQm2NBNahV6LmX14Xq9WwZTL1wPjaSglUuVzYgwrq+0EuI4+vKvQHHw==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js" integrity="sha512-9GIHU4rPKUMvNOHFOer5Zm2zHnZOjayOO3lZpokhhCtgt8FNlNiW/bb7kl0R5ZXfCDVPcQ8S4oBdNs92p5Nm2w==" crossorigin="anonymous"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script data-ad-client="ca-pub-9566151416325480" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#2176ff">
<meta name="msapplication-TileColor" content="#eeeef2">
<meta name="theme-color" content="#eeeef2">


  <title>OAuth en Forms con Xamarin.Auth | That C# guy</title>

  <!-- Search Engine -->
  <meta name="description" content="Con Xamarin.Auth, el incorporar servicios de terceros como Twitter y Facebook nunca había sido tan fácil, en este post, aprende a hacerlo desde Xamarin.Forms.">
  <meta name="image" content="">
  <!-- Schema.org for Google -->
  <meta itemprop="name" content="OAuth en Forms con Xamarin.Auth">
  <meta itemprop="description" content="Con Xamarin.Auth, el incorporar servicios de terceros como Twitter y Facebook nunca había sido tan fácil, en este post, aprende a hacerlo desde Xamarin.Forms.">
  <meta itemprop="image" content="">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="OAuth en Forms con Xamarin.Auth">
  <meta name="twitter:description" content="Con Xamarin.Auth, el incorporar servicios de terceros como Twitter y Facebook nunca había sido tan fácil, en este post, aprende a hacerlo desde Xamarin.Forms.">
  <meta name="twitter:site" content="@io_exception">
  <meta name="twitter:creator" content="@io_exception">
  <meta name="twitter:image" content="">
  <!-- Open Graph general (Facebook, Pinterest & Google+) -->
  <meta name="og:title" content="OAuth en Forms con Xamarin.Auth">
  <meta name="og:description" content="Con Xamarin.Auth, el incorporar servicios de terceros como Twitter y Facebook nunca había sido tan fácil, en este post, aprende a hacerlo desde Xamarin.Forms.">
  <meta name="og:image" content="">
  <meta name="og:url" content="https://thatcsharpguy.com/">
  <meta name="og:site_name" content="That C# guy">
  <meta name="og:locale" content="es">
  <meta name="og:type" content="website">


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GPXCSH21CP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GPXCSH21CP');
</script>

        
    </head>
    <body style="position: relative; min-height: 100%; top: 0px;">
        <header class="site-header " role="banner">
  <div class="wrapper">
     <div class="site-header-inner">
       <span class="site-brand">
         <a class="site-brand-inner" rel="author" href="/">
          <!-- <img class="site-favicon" title="Your awesome title" src="" onerror="this.style.display='none'"> -->
          That C# guy
        </a>
      </span>
        <nav class="site-nav">
           <input type="checkbox" id="nav-trigger" class="nav-trigger">
           <label for="nav-trigger">
              <span class="menu-icon">
                 <svg viewbox="0 0 18 15" width="18px" height="15px">
                    <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
                 </svg>
              </span>
           </label>
           <div class="trigger">
             <!-- Header links -->
              <a class="page-link" target="_blank" href="https://www.youtube.com/thatcsharpguy/">YOUTUBE</a>
              <span class="page-link">
    <div id="google_translate_element" style="display: none;"></div>
    <span class="ct-language">
       <ul class="list-unstyled ct-language-dropdown">
         <li>
            <a href="#" class="lang-select" data-lang="es">
            <img src="https://www.countryflags.io/mx/flat/64.png" title="México">
            </a>
         </li>
          <li>
             <a href="#" class="lang-select" data-lang="en">
             <img src="https://www.countryflags.io/gb/flat/64.png" title="English">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="fr">
             <img src="https://www.countryflags.io/fr/flat/64.png" title="Franch">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="zh-CN">
             <img src="https://www.countryflags.io/cn/flat/64.png" title="Chinese(Simple)">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ja">
             <img src="https://www.countryflags.io/jp/flat/64.png" title="Japan">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ko">
             <img src="https://www.countryflags.io/kr/flat/64.png" title="Korean">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ru">
             <img src="https://www.countryflags.io/ru/flat/64.png" title="Russia">
             </a>
          </li>
       </ul>
    </span>
    <script type="text/javascript">
       function googleTranslateElementInit() {
         new google.translate.TranslateElement({
           pageLanguage: '',
           autoDisplay: false,
           layout: google.translate.TranslateElement.InlineLayout.VERTICAL
         }, 'google_translate_element');
       
         function restoreLang() {
           var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
           if (!iframe) return;
       
           var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
           var restore_el = innerDoc.getElementsByTagName("button");
       
           for (var i = 0; i < restore_el.length; i++) {
             if (restore_el[i].id.indexOf("restore") >= 0) {
               restore_el[i].click();
               var close_el = innerDoc.getElementsByClassName("goog-close-link");
               close_el[0].click();
               return;
             }
           }
         }
       
         function triggerHtmlEvent(element, eventName) {
           var event;
           if (document.createEvent) {
             event = document.createEvent('HTMLEvents');
             event.initEvent(eventName, true, true);
             element.dispatchEvent(event);
           } else {
             event = document.createEventObject();
             event.eventType = eventName;
             element.fireEvent('on' + event.eventType, event);
           }
         }
       
         var googleCombo = document.querySelector("select.goog-te-combo");
         var langSelect = document.querySelector('.ct-language');
         langSelect.addEventListener('click', function(event) {
           if (!event.target) {
             return;
           }
       
           var selected = document.querySelector('.ct-language .ct-language-selected');
           if (selected) {
             selected.classList.remove('ct-language-selected');
           }
       
           var target = event.target;
           while (target && target !== langSelect ) {
             if (target.matches('.lang-select')) {
               break;
             }
             target = target.parentElement;
           }
       
           if (target && target.matches('.lang-select')) {
             var lang = target.getAttribute('data-lang');
             if (lang == "es") {
               restoreLang();
             } else {
               target.parentElement.classList.add('ct-language-selected');
               googleCombo.value = lang;
               triggerHtmlEvent(googleCombo, 'change');
             }
           }
       
           event.preventDefault();
         });
       }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
 </span>
           </div>
        </nav>
     </div>
  </div>
</header>
<script>
  (function() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;

      documentElement.setAttribute("data-header-transparent", "");

      var scrollStatus = "";
      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }
      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }
    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });
    storeScrollData();
  })();
</script>
        
        <div class="theme-toggle">
  <input type="checkbox" id="theme-switch"/>
  <label for="theme-switch">
      <div class="toggle"></div>
      <div class="names">
          <p class="light">Light</p>
          <p class="dark">Dark</p>
      </div>
  </label>
</div>
  


<script>
    (function() {
      var sw = document.getElementById('theme-switch');
      var html = document.getElementsByTagName('html')[0];
      var nightModeOption = ('auto' || 'auto').toLowerCase();
      var storage = nightModeOption === 'manual'
          ? localStorage
          : sessionStorage;
      var themeData = loadThemeData();
  
      function saveThemeData(data) {
        storage.setItem('theme', JSON.stringify(data));
      }
  
      function loadThemeData() {
        var data = storage.getItem('theme');
        try {
          data = JSON.parse(data ? data : '');
        } catch(e) {
          data = { nightShift: undefined, autoToggleAt: 0 };
          saveThemeData(data);
        }
        return data;
      }
  
      function handleThemeToggle(nightShift) {
        themeData.nightShift = nightShift;
        saveThemeData(themeData);
        html.dataset.theme = nightShift ? 'dark' : 'light';
        setTimeout(function() {
          sw.checked = nightShift ? true : false;
        }, 50);
      }
  
      function autoThemeToggle() {
        // Next time point of theme toggle
        var now = new Date();
        var toggleAt = new Date();
        var hours = now.getHours();
        var nightShift = hours >= 19 || hours <=7;
  
        if (nightShift) {
          if (hours > 7) {
            toggleAt.setDate(toggleAt.getDate() + 1);
          }
          toggleAt.setHours(7);
        } else {
          toggleAt.setHours(19);
        }
  
        toggleAt.setMinutes(0);
        toggleAt.setSeconds(0);
        toggleAt.setMilliseconds(0)
  
        var delay = toggleAt.getTime() - now.getTime();
  
        // auto toggle theme mode
        setTimeout(function() {
          handleThemeToggle(!nightShift);
        }, delay);
  
        return {
          nightShift: nightShift,
          toggleAt: toggleAt.getTime()
        };
      }
  
      // Listen the theme toggle event
      sw.addEventListener('change', function(event) {
        handleThemeToggle(event.target.checked);
      });
  
      if (nightModeOption == 'auto') {
        var data = autoThemeToggle();
  
        // Toggle theme by local setting
        if (data.toggleAt > themeData.autoToggleAt) {
          themeData.autoToggleAt = data.toggleAt;
          handleThemeToggle(data.nightShift);
        } else {
          handleThemeToggle(themeData.nightShift);
        }
      } else if (nightModeOption == 'manual') {
        handleThemeToggle(themeData.nightShift);
      } else {
        var nightShift = themeData.nightShift;
        if (nightShift === undefined) {
          nightShift = nightModeOption === 'on';
        }
        handleThemeToggle(nightShift);
      }
    })();
  </script>
        <div class="page-content">
            <div class="wrapper">
                <div class="framework">
                    <section class="main"> 
                        
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="post-content e-content" itemprop="articleBody">
        <h1>OAuth en Forms con Xamarin.Auth</h1>
        
<div class="warning">
Este post debe ser usado como guía, como sabrás, en ningún momento es buena idea dejar poner en tu código cualquier tipo de llave que no quieres que sea pública (como los AppSecrets o los Tokens). Te recomiendo visitar estos elnaces: <a href="http://www.androidauthority.com/how-to-hide-your-api-key-in-android-600583/" target="blank">How to hide your key</a> y <a href="https://stormpath.com/blog/the-ultimate-guide-to-mobile-api-security" target="blank">The Ultimate Guide to Mobile API Security</a> para mayor información.
</div>
Es un hecho que las redes sociales están dominando el mundo, y que tu app tenga conexión con alguna (o varias) de ellas es una característica que tal vez tus usuarios apreciarían en ella. Sin embargo, para acceder a ellas es necesario contar con el permiso de los usuarios, ¿cierto?  
<p>Para nuestra suerte, muchos servicios proporcionan una forma rápida y estandarizada de solicitar dicho permiso de ellos y es través de <a href="https://oauth.net" target="_blank">OAuth</a>. Sin embargo, el proceso que ocurre despues de que los usuarios nos han dado permiso no es <a href="https://oauth.net/core/diagram.png" target="_blank">tan sencillo como parece</a>, para nuestra suerte, <strong>Xamarin.Auth</strong> nos ofrece una forma de ejecutar este proceso de manera sencilla y en unas cuantas líneas de código.</p>
<p>En este post, trataré de explicar cómo usar Xamarin.Auth para conectarse con GitHub, Facebook y Twitter.</p>
<h2 id="registrando-aplicaciones-en-servicios">Registrando aplicaciones en servicios</h2>
<p>Primero que nada, tenemos que registrar nuestras aplicaciones en los servicios de terceros:</p>
<h3 id="github">GitHub</h3>
<p>Lo primero que tienes que hacer es darte de alta en el programa de desarrolladores de GitHub en <a href="https://developer.github.com/program/" target="_blank">este enlace</a> y una vez que lo hayas hecho, debes dirigirte a <a href="https://github.com/settings/developers" target="_blank">este otro enlace</a> en donde podrás registrar tu nueva app, en la pantalla de registro debes poner los datos de tu app, pero debes colocar <code>https://github.com</code> en el campo <em>&quot;Authorization callback URL&quot;</em>:</p>
<img src="https://thatcsharpguy.github.io/postimages/xamarin/auth/github-developer-2.jpg" title="Registro de nueva aplicación" />
<p>Una vez que has completado estos pasos, tu aplicación estará registrada y lista para usarse, una vez creada te aparecerán dos valores que son muy importantes y que debes guardar con mucho cuidado:</p>
<img src="https://thatcsharpguy.github.io/postimages/xamarin/auth/github-keys.jpg" title="GitHub keys" />
<h3 id="facebook">Facebook</h3>
<p>Para Facebook la cosa no es tan diferente, debes acceder a <a href="https://developers.facebook.com" target="_blank">https://developers.facebook.com</a> y registrarte como desarrollador para después registrar tu aplicación en el mismo sitio. Ahora, después de elegir un nombre para nuestra aplicación, de proporcionar un correo electrónico para contacto y resolver un captcha, nos aparecerá una pantalla con un menú como el siguiente y en el cual debemos dar click en <em>&quot;Add product&quot;</em> y seleccionar <em>&quot;Facebook Login&quot;</em>:</p>
<img src="https://thatcsharpguy.github.io/postimages/xamarin/auth/fb-app-addlogin.jpg" title="Add product" />
<p>Una vez que hayamos hecho esto, del lado izquierdo, aparecerá un nuevo ítem en el menú llamado, justamente, <em>&quot;Facebook Login&quot;</em> con dos opciones debajo, damos click en <em>&quot;Settings&quot;</em>, después de esto aparecerá un formulario, en donde lo que tenemos que modificar es el campo <em>&quot;Valid OAuth redirect URIs&quot;</em>, en donde debes colocar lo siguiente: <code>https://www.facebook.com/connect/login_success.html</code>:</p>
<img src="https://thatcsharpguy.github.io/postimages/xamarin/auth/oauthredirectaddr.png" title="Modificar url de redirección" />
<p>Guardamos los cambios y ahora, en el menú de la izquierda damos click en <em>&quot;Dashboard&quot;</em>, que nos llevará a la pantalla inicial de nuestra app, de donde debemos copiar el valor de <em>&quot;App ID&quot;</em> y listo, hemos terminado de registrar nuestra app en Facebook.</p>
<h3 id="twitter">Twitter</h3>
<p>Básicamente, ahora que has registrado tu app en GitHub y Facebook, sabrás más o menos qué esperar con Twitter. Primero, tienes que iniciar el registro de tu app en <a href="https://apps.twitter.com" target="_blank">https://apps.twitter.com</a>, de nuevo, debemos ingresar detalles sobre la app y, <strong>muy importante</strong>, en el campo <em>&quot;Callback URL&quot;</em> debemos colocar <code>https://mobile.twitter.com/home</code>. Una vez dada de alta, tendremos acceso a una <em>&quot;Consumer Key&quot;</em> y a un <em>&quot;Consumer Secret&quot;</em>, este último debe permanecer <strong>siempre secreto</strong>:</p>
<img src="https://thatcsharpguy.github.io/postimages/xamarin/auth/twttr-keys.jpg" title="Llaves Twitter" />
<p>Bien, hemos terminado el papeleo, ahora, a escribir código:</p>
<h2 id="en-el-proyecto-de-forms">En el proyecto de Forms</h2>
<p>Comenzaremos por crear una interfaz que especifique algunas de las propiedades comunes a la hora de realizar la autenticación:</p>
<pre><code class="language-csharp">public interface IKeys
{
    string ClientId { get; }
    string ClientSecret { get; }
    string Scope { get; }
    string AuthorizeUrl { get; }
    string RedirectUrl { get; }
    string RequestTokenUrl { get; }
    string AccessTokenUrl { get; }
    string ConsumerSecret { get; }
    string ConsumerKey { get; }
    string CallbackUrl { get; }
}
</code></pre>
<p>Ahora es cuando tenemos que usar los valores obtenidos en la fase de &quot;El Papeleo&quot;, creamos una clase por cada servicio conectado, fijate cómo es que las clases implementan la interfaz IKey:</p>
<pre><code class="language-csharp">public class FacebookKeys : IKeys
{
    public string ClientId { get; } = &quot;XXXXXXXXX&quot;; // El valor de App ID en el Dashobard
    public string AuthorizeUrl { get; } = &quot;https://m.facebook.com/dialog/oauth/&quot;;
    public string RedirectUrl { get; } = &quot;https://www.facebook.com/connect/login_success.html&quot;;
    // ...

public class GitHubKeys : IKeys
{
    public string ClientId =&gt; &quot;XXXXXXXXXX&quot;; // El valor de Client Id de GitHub
    public string ClientSecret =&gt; &quot;XXXXXXXXXXXXXXXX&quot;; // El valor de Client Secret de GitHub
    public string AccessTokenUrl { get; } = &quot;https://github.com/login/oauth/access_token&quot;;
    public string AuthorizeUrl { get; } = &quot;https://github.com/login/oauth/authorize&quot;;
    public string RedirectUrl { get; } = &quot;https://github.com&quot;;
    // ...

public class TwitterKeys : IKeys
{
    public string ConsumerKey { get; } = &quot;EnPK4XXXXXXXtrwXXXXXXXEm&quot;; // Consumer Key de Twitter
    public string ConsumerSecret =&gt; &quot;FhSHfXXXXXXXXyu0ZqXXXXXXXXXXXXhbFcr8ETG2p&quot;; // Consumer Secret de Twitter
    public string AccessTokenUrl { get; } = &quot;https://api.twitter.com/oauth/access_token&quot;;
    public string AuthorizeUrl { get; } = &quot;https://api.twitter.com/oauth/authorize&quot;;
    public string RedirectUrl { get; } = &quot;https://mobile.twitter.com/home&quot;;
    public string RequestTokenUrl =&gt; &quot;https://api.twitter.com/oauth/request_token&quot;;
    public string CallbackUrl =&gt; &quot;https://mobile.twitter.com/home&quot;;
    //
</code></pre>
<p>Además de un <a href="../c-sharp-enums" target="_blank">tipo <code>enum</code></a> que represente a los servicios que podemos usar, usamos un <code>enum</code> para evitar usar cadenas mágicas en el código:</p>
<pre><code class="language-csharp">public enum Services
{
    GitHub,
    Facebook,
    Twitter
}
</code></pre>
<p>Dado que Xamarin.Auth hace uso de APIs nativas de cada platforma, sus métodos son únicamente accesibles en los proyectos &quot;cliente&quot; y no desde el núcleo de nuestra aplicación, es por eso que para interactuar con ella indepentiéntemente de la plataforma, necesitamos hacer uso de una interfaz:</p>
<pre><code class="language-csharp">public interface IAccountManagerService
{
    List&lt;Services&gt; Accounts { get; }

    string GetPropertyFromAccount(Services service, string property);

    void EraseAll();
}
</code></pre>
<p>La pantalla de autorización es una nueva <code>Activity</code> o un nuevo <code>UIViewController</code>, dependiendo de la plataforma, y como desde Forms no tenemos acceso a estas clases, de nuevo creamos una solución independiente de la plataforma. En este caso lo haremos a través de un <a href="https://developer.xamarin.com/guides/xamarin-forms/custom-renderer/contentpage/" target="_blank"><i>Custom renderer</i></a> de una <code>ContentPage</code>:</p>
<pre><code class="language-csharp">public class AuthorizePage : ContentPage
{
    public Services Service { get; private set; }

    public AuthorizePage(Services service)
    {
        Service = service;
    }
}
</code></pre>
<p>Como puedes ver, tiene una propiedad llamada <code>Service</code> del tipo <code>Service</code>, a través de la cual especificaremos a cuál de los servicios nos vamos a conectar. Más adelante demostraré el uso de este tipo de páginas.</p>
<h2 id="en-xamarin.ios-y-xamarin.android">En Xamarin.iOS y Xamarin.Android</h2>
<p>Una vez terminado el código multiplataforma, vamos a trabajar con los proyectos de iOS y Android; como las diferencias entre un código y otro son mínimas, podemos utilizar un proyecto compartido y usar <a href="../directivas-preprocesador-c-sharp" target="_blank">directivas de preprocesador</a> para compilar determinadas porciones de código de acuerdo al proyecto que estamos ejecutando.</p>
<p>Comenzaremos por implementar la interfaz <code>IAccountManagerService</code> a través de la que interactuaremos con el servicio de gestión de cuentas de Xamarin.Auth:</p>
<pre><code class="language-csharp">using System;
using System.Linq;
using System.Collections.Generic;
using Authy.AccountManagement;

#if __IOS/
namespace Authy.iOS.AccountManagement
#elif __ANDROID/
namespace Authy.Droid.AccountManagement
#endif
{
	public class AccountManagementImplementation : IAccountManagerService
	{
		public List&lt;Services&gt; Accounts
		{
			get
			{
				var accounts = new List&lt;Services&gt;();
				var accountStore = Xamarin.Auth.AccountStore.Create();
				foreach (var service in Enum.GetNames(typeof(Services)))
				{
					var acc = accountStore.FindAccountsForService(service).FirstOrDefault();
					if (acc != null)
					{
						accounts.Add((Services)Enum.Parse(typeof(Services), service));
					}
				}
				return accounts;
			}
		}

		public void EraseAll()
		{
			var accountStore = Xamarin.Auth.AccountStore.Create();
			foreach (var service in Enum.GetNames(typeof(Services)))
			{
				var acc = accountStore.FindAccountsForService(service).FirstOrDefault();
				if (acc != null)
				{
					accountStore.Delete(acc, service);
				}
			}
		}

		public string GetPropertyFromAccount(Services service, string property)
		{
			var accountStore = Xamarin.Auth.AccountStore.Create();
			var account = accountStore.FindAccountsForService(service.ToString()).FirstOrDefault();
			if (account != null)
			{
				return account.Properties[property];
			}
			return null;
		}
	}
}
</code></pre>
<p>Para esta ocasión estaremos usando otra de las herramientas de XF, el <a href="https://developer.xamarin.com/guides/xamarin-forms/dependency-service/" target="_blank">DependencyService</a>, así que no te olvides de colocar la siguiente línea en tu archivo:</p>
<pre><code class="language-csharp">[assembly: Xamarin.Forms.Dependency(typeof(AccountsImplementation))]
</code></pre>
<p>Después, es momento de implementar el <em>custom renderer</em> de la página con la que vamos a solicitar la autorización:</p>
<pre><code class="language-csharp">using System;
using Authy.AccountManagement;
using Xamarin.Forms;
using Xamarin.Auth;
#if __IOS/
using Xamarin.Forms.Platform.iOS;
#elif __ANDROID/
using Xamarin.Forms.Platform.Android;
#endif

#if __IOS/
[assembly: ExportRenderer(typeof(AuthorizePage), typeof(Authy.iOS.AccountManagement.AuthorizePageRenderer))]
namespace Authy.iOS.AccountManagement
#elif __ANDROID/
[assembly: ExportRenderer(typeof(AuthorizePage), typeof(Authy.Droid.AccountManagement.AuthorizePageRenderer))]
namespace Authy.Droid.AccountManagement
#endif
{
	public class AuthorizePageRenderer : PageRenderer
	{

#if __IOS/
		public override void ViewDidAppear(bool animated)
		{
			base.ViewDidAppear(animated);
#elif __ANDROID/
		protected override void OnElementChanged(ElementChangedEventArgs&lt;Page&gt; e)
		{
			base.OnElementChanged(e);
			var activity = this.Context as Android.App.Activity;
#endif


			OAuth2Authenticator auth2 = null;
			OAuth1Authenticator auth1 = null;
			IKeys keys = null;

			var authPage = Element as AuthorizePage;

			switch (authPage.Service)
			{
				case Services.Facebook:
					keys = new FacebookKeys();
					auth2 = new OAuth2Authenticator(
						clientId: keys.ClientId,
						scope: keys.Scope,
						authorizeUrl: new Uri(keys.AuthorizeUrl),
						redirectUrl: new Uri(keys.RedirectUrl));
					break;
				case Services.Twitter:
					keys = new TwitterKeys();
					auth1 = new OAuth1Authenticator(
							consumerKey: keys.ConsumerKey,
							consumerSecret: keys.ConsumerSecret,
							requestTokenUrl: new Uri(keys.RequestTokenUrl),
							authorizeUrl: new Uri(keys.AuthorizeUrl),
							accessTokenUrl: new Uri(keys.AccessTokenUrl),
							callbackUrl: new Uri(keys.CallbackUrl));
					break;
				case Services.GitHub:
					keys = new GitHubKeys();
					auth2 = new OAuth2Authenticator(
						clientId: keys.ClientId,
						clientSecret: keys.ClientSecret,
						scope: keys.Scope,
						authorizeUrl: new Uri(keys.AuthorizeUrl),
						redirectUrl: new Uri(keys.RedirectUrl),
						accessTokenUrl: new Uri(keys.AccessTokenUrl));
					break;
				default:
					throw new Exception(&quot;Service &quot; + authPage.Service + &quot; not yet supported&quot;);
			}

			if (auth2 != null)
			{
				auth2.Completed += async (sender, eventArgs) =&gt;
				{
#if __IOS/
					DismissViewController(true, null);
#endif
					if (eventArgs.IsAuthenticated)
						AccountStore.Create().Save(eventArgs.Account, authPage.Service.ToString());
					await authPage.Navigation.PopAsync();
				};
#if __IOS/
				PresentViewController(auth2.GetUI(), true, null);
#elif __ANDROID/
				activity.StartActivity(auth2.GetUI(activity));
#endif
			}

			if (auth1 != null)
			{
				auth1.Completed += async (sender, eventArgs) =&gt;
				{
#if __IOS/
					DismissViewController(true, null);
#endif
					if (eventArgs.IsAuthenticated)
						AccountStore.Create().Save(eventArgs.Account, authPage.Service.ToString());
					await authPage.Navigation.PopAsync();
				};
			
#if __IOS/
				PresentViewController(auth1.GetUI(), true, null);
#elif __ANDROID/
				activity.StartActivity(auth1.GetUI(activity));
#endif
			}

		}
	}

}
</code></pre>
<p>Lo que el código anterior hace es declarar dos formas de obtener la autorización (<code>OAuth2Authenticator</code> y <code>OAuth2Authenticator</code>), también delcara una variable del tipo <code>IKeys</code>.</p>
<p>Luego obtiene una referencia a la página de Xamarin.Forms desde la que estamos llamándola (para saber a qué servicio queremos conectarnos), con esta información comienza a crear la petición adecuada de acuerdo al servicio que solicitamos. Es importante que veas que dentro de cada una de las opciones de la instrucción <code>switch</code>, se instancia la clase que contiene las llaves del servicio que vamos a usar.</p>
<p>Por último, y después de que se ha creado correctamente una instancia de <code>OAuth2Authenticator</code> o de <code>OAuth1Authenticator</code>, asigna un manejador al evento <code>Completed</code>, para que si se obtuvo el permiso requerido lo almacene en el dispositivo mediante la llamada a <code>AccountStore.Create().Save()</code>. Luego de todo esto, podemos mostrar la pantalla al usuario. En android mediante el método <code>StartActivity</code>, mientras que en iOS mediante <code>PresentViewController</code>.</p>
<p>De este modo, cada vez que naveguemos hacia una página del tipo <code>AuthorizePage</code>, se mostrará la interfaz de autorización solicitada, de acuerdo al valor pasado en el constructor de la clase.</p>
<p>Ese es todo el código que necesitas para los proyectos &quot;cliente&quot;. Ahora, de vuelta al proyecto de Forms:</p>
<h2 id="de-vuelta-en-xamarin.forms">De vuelta en Xamarin.Forms</h2>
<p>Cuando solicitemos permiso para usar determinado servicio, lo único que debemos hacer es crear una nueva página en Forms y navegar hacia ella:</p>
<pre><code class="language-csharp">await Navigation.PushAsync(new AuthorizePage(Services.Facebook));
</code></pre>
<p>Para corroborar si el usuario ha otorgado permiso debemos obtener las cuentas que tenemos guardadas en el dispositivo usando la implementación de la clase <code>IAccountManagerService</code> del servicio de dependencias:</p>
<pre><code class="language-csharp">_services = DependencyService.Get&lt;IAccountManagerService&gt;();
</code></pre>
<p>Y luego revisar la propiedad <code>Accounts</code> buscando si existe el servicio que deseamos:</p>
<pre><code class="language-csharp">var accounts = _services.Accounts;
if (accounts.Contains(Services.Facebook))
{ // ...
</code></pre>
<p>Si sabemos que el usuario nos ha autorizado, podemos acceder a los tokens, claves y demás información de permisos mediante el método <code>GetPropertyFromAccount</code>:</p>
<pre><code class="language-csharp">var screen_name = _services.GetPropertyFromAccount(Services.Twitter, &quot;screen_name&quot;);
var oauth_consumer_key = _services.GetPropertyFromAccount(Services.Twitter, &quot;oauth_consumer_key&quot;);
var oauth_token_secret = _services.GetPropertyFromAccount(Services.Twitter, &quot;oauth_token_secret&quot;);
</code></pre>
<h2 id="demo">Demo</h2>
<p>Puedes ver el vídeo de la app que usa el código explicado en el código anterior:</p>
<div class="pure-g">
<div class="pure-u-1 pure-u-md-1-2">
<img src="//i.imgur.com/7tBrHtI.gif" />
</div>
<div class="pure-u-1 pure-u-md-1-2">
<img src="http://i.giphy.com/11S78bw1xcfodi.gif" />
</div>  
</div> 
<h2 id="para-finalizar">Para finalizar</h2>
<p>Como puedes ver no es tan complicado (espero me haya explicado bien), y añadir otros servicios es tan simple como conseguir las llaves, modificar unas cuantas clases y ¡listo! Tu app se puede conectar con el resto del internet.</p>
<p>No olvides que me puedes preguntar dudas por correo o por Twitter, ah... y <a href="https://github.com/fferegrino/Authy" target="_blank"><strong>descargar el código fuente</strong></a>.</p>


    </div>
</article>

                    </section>
                    <section class="sidebar">
                        <div class="theme-toggle">
  <input type="checkbox" id="theme-switch"/>
  <label for="theme-switch">
      <div class="toggle"></div>
      <div class="names">
          <p class="light">Light</p>
          <p class="dark">Dark</p>
      </div>
  </label>
</div>
  


<script>
    (function() {
      var sw = document.getElementById('theme-switch');
      var html = document.getElementsByTagName('html')[0];
      var nightModeOption = ('auto' || 'auto').toLowerCase();
      var storage = nightModeOption === 'manual'
          ? localStorage
          : sessionStorage;
      var themeData = loadThemeData();
  
      function saveThemeData(data) {
        storage.setItem('theme', JSON.stringify(data));
      }
  
      function loadThemeData() {
        var data = storage.getItem('theme');
        try {
          data = JSON.parse(data ? data : '');
        } catch(e) {
          data = { nightShift: undefined, autoToggleAt: 0 };
          saveThemeData(data);
        }
        return data;
      }
  
      function handleThemeToggle(nightShift) {
        themeData.nightShift = nightShift;
        saveThemeData(themeData);
        html.dataset.theme = nightShift ? 'dark' : 'light';
        setTimeout(function() {
          sw.checked = nightShift ? true : false;
        }, 50);
      }
  
      function autoThemeToggle() {
        // Next time point of theme toggle
        var now = new Date();
        var toggleAt = new Date();
        var hours = now.getHours();
        var nightShift = hours >= 19 || hours <=7;
  
        if (nightShift) {
          if (hours > 7) {
            toggleAt.setDate(toggleAt.getDate() + 1);
          }
          toggleAt.setHours(7);
        } else {
          toggleAt.setHours(19);
        }
  
        toggleAt.setMinutes(0);
        toggleAt.setSeconds(0);
        toggleAt.setMilliseconds(0)
  
        var delay = toggleAt.getTime() - now.getTime();
  
        // auto toggle theme mode
        setTimeout(function() {
          handleThemeToggle(!nightShift);
        }, delay);
  
        return {
          nightShift: nightShift,
          toggleAt: toggleAt.getTime()
        };
      }
  
      // Listen the theme toggle event
      sw.addEventListener('change', function(event) {
        handleThemeToggle(event.target.checked);
      });
  
      if (nightModeOption == 'auto') {
        var data = autoThemeToggle();
  
        // Toggle theme by local setting
        if (data.toggleAt > themeData.autoToggleAt) {
          themeData.autoToggleAt = data.toggleAt;
          handleThemeToggle(data.nightShift);
        } else {
          handleThemeToggle(themeData.nightShift);
        }
      } else if (nightModeOption == 'manual') {
        handleThemeToggle(themeData.nightShift);
      } else {
        var nightShift = themeData.nightShift;
        if (nightShift === undefined) {
          nightShift = nightModeOption === 'on';
        }
        handleThemeToggle(nightShift);
      }
    })();
  </script>
                        <div class="post-menu">
                            <div class="post-menu-title">Sígueme en</div>
                            <div class="common-list">
                                <ul>
                                    
                                    <li>
                                        <a href="https://github.com/fferegrino">GitHub<span><i class="fab fa-github"></i></span></a>
                                    </li>
                                    
                                    <li>
                                        <a href="https://twitter.com/io_exception">Twitter<span><i class="fab fa-twitter"></i></span></a>
                                    </li>
                                    
                                    <li>
                                        <a href="https://youtube.com/thatcsharpguy">YouTube<span><i class="fab fa-youtube"></i></span></a>
                                    </li>
                                    
                                    <li>
                                        <a href="https://tcsg.dev/discord">Discord<span><i class="fab fa-discord"></i></span></a>
                                    </li>
                                    
                                </ul>
                            </div>
                        </div>
                        
 <style type="text/css" media="screen">
    .post-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
</style>
<div class="post-menu toc">
    <div class="post-menu-title">TOC</div>
    <div class="post-menu-content"></div>
</div>
<script>
    function generateContent() {
        var menu = document.querySelector(".post-menu.toc");
        console.log(menu);
        var menuContent = menu.querySelector(".post-menu-content");
        var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");
        // Hide menu when no headings
        if (headings.length === 0) {
            return menu.style.display = "none";
        }
        // Generate post menu
        var menuHTML = '';
        for (var i = 0; i < headings.length; i++) {
            var h = headings[i];
            menuHTML += ('<li class="h-' + h.tagName.toLowerCase() + '">' + '<a href="#' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
        }
        menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';
        // The header element
        var header = document.querySelector('header.site-header');
        function doMenuCollapse(index, over_items) {
            var items = menuContent.firstChild.children;
            if (over_items == undefined) {
                over_items = 20;
            }
            if (items.length<over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0 && ! items[beginIndex].classList.contains('h-h2')) {
                beginIndex -= 1;
            }
            while (endIndex < items.length && ! items[endIndex].classList.contains('h-h2')) {
                endIndex += 1;
            }
            for (var i = 0; i < beginIndex; i++) {
                item = items[i]
                if (!item.classList.contains('h-h2')) {
                    item.style.display = 'none';
                }
            }
            for (var i = beginIndex + 1; i < endIndex; i++) {
                item = items[i]
                // if (!item.classList.contains('h-h2')) {
                item.style.display = '';
                // }
            }
            for (var i = endIndex; i < items.length; i++) {
                item = items[i]
                if (!item.classList.contains('h-h2')) {
                    item.style.display = 'none';
                }
            }
        }
        // Init menu collapsed
        doMenuCollapse(-1);
        // Active the menu item
        window.addEventListener('scroll', function (event) {
            var lastActive = menuContent.querySelector('.active');
            var changed = true;
            var activeIndex = -1;
            for (var i = headings.length - 1; i >= 0; i--) {
                var h = headings[i];
                var headingRect = h.getBoundingClientRect();
                var headerRect = header.getBoundingClientRect();
                var headerTop = Math.floor(headerRect.top);
                var headerHeight = Math.floor(headerRect.height);
                var headerHeight = headerTop + headerHeight + 20;
                if (headingRect.top <= headerHeight) {
                    var id = 'h-' + h.getAttribute('id');
                    var a = menuContent.querySelector('a[href="#' + id + '"]');
                    var curActive = a.parentNode;
                    if (curActive) {
                        curActive.classList.add('active');
                        activeIndex = i;
                    }
                    if (lastActive == curActive) {
                        changed = false;
                    }
                    break;
                }
            }
            if (changed) {
                if (lastActive) {
                    lastActive.classList.remove('active');
                }
                doMenuCollapse(activeIndex);
            }
            event.preventDefault();
        });
    }
    document.addEventListener("DOMContentLoaded", function() {
        generateContent()
    });
</script>

                    </section>
                </div>
            </div>
        </div>
        <footer class="site-footer h-card">
   <data class="u-url" href="/"></data>
 
   <div class="wrapper">
     <div class="site-footer-inner">
       <div> </div>
       <div>Powered by <a title="Lockdonw in a simple, blog-aware, static site generator." href="https://github.com/lockdownblog/lockdown">Lockdown</a> &amp; <a title="Yat, yetanother theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
       <!-- <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></div> -->
     </div>
   </div>
 </footer>
    </body>
</html>