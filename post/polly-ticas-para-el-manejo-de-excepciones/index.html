<!DOCTYPE html>
<html lang="es" itemscope itemtype="http://schema.org/Blog">
    <head>
        <!–– Made with Lockdown: https://github.com/fferegrino/lockdown ––>
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c"></meta>

  <link rel="shortcut icon" href="">
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->
  <script src="https://kit.fontawesome.com/0271495296.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/css/main.css">
  <script src="/js/main.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/vs.min.css" integrity="sha512-aWjgJTbdG4imzxTxistV5TVNffcYGtIQQm2NBNahV6LmX14Xq9WwZTL1wPjaSglUuVzYgwrq+0EuI4+vKvQHHw==" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js" integrity="sha512-9GIHU4rPKUMvNOHFOer5Zm2zHnZOjayOO3lZpokhhCtgt8FNlNiW/bb7kl0R5ZXfCDVPcQ8S4oBdNs92p5Nm2w==" crossorigin="anonymous"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script data-ad-client="ca-pub-9566151416325480" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#2176ff">
<meta name="msapplication-TileColor" content="#eeeef2">
<meta name="theme-color" content="#eeeef2">


  <title>Polly-ticas para el manejo de excepciones | That C# guy</title>

  <!-- Search Engine -->
  <meta name="description" content="Con Polly implementa políticas complejas para lidiar con las excepciones en tu código, especialmente útil si estás trabajando con servicios web que pueden variar de disponibilidad de un momento a otro.">
  <meta name="image" content="">
  <!-- Schema.org for Google -->
  <meta itemprop="name" content="Polly-ticas para el manejo de excepciones">
  <meta itemprop="description" content="Con Polly implementa políticas complejas para lidiar con las excepciones en tu código, especialmente útil si estás trabajando con servicios web que pueden variar de disponibilidad de un momento a otro.">
  <meta itemprop="image" content="">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Polly-ticas para el manejo de excepciones">
  <meta name="twitter:description" content="Con Polly implementa políticas complejas para lidiar con las excepciones en tu código, especialmente útil si estás trabajando con servicios web que pueden variar de disponibilidad de un momento a otro.">
  <meta name="twitter:site" content="@io_exception">
  <meta name="twitter:creator" content="@io_exception">
  <meta name="twitter:image" content="">
  <!-- Open Graph general (Facebook, Pinterest & Google+) -->
  <meta name="og:title" content="Polly-ticas para el manejo de excepciones">
  <meta name="og:description" content="Con Polly implementa políticas complejas para lidiar con las excepciones en tu código, especialmente útil si estás trabajando con servicios web que pueden variar de disponibilidad de un momento a otro.">
  <meta name="og:image" content="">
  <meta name="og:url" content="https://thatcsharpguy.com/">
  <meta name="og:site_name" content="That C# guy">
  <meta name="og:locale" content="es">
  <meta name="og:type" content="website">


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GPXCSH21CP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GPXCSH21CP');
</script>

        
    </head>
    <body style="position: relative; min-height: 100%; top: 0px;">
        <header class="site-header " role="banner">
  <div class="wrapper">
     <div class="site-header-inner">
       <span class="site-brand">
         <a class="site-brand-inner" rel="author" href="/">
          <!-- <img class="site-favicon" title="Your awesome title" src="" onerror="this.style.display='none'"> -->
          That C# guy
        </a>
      </span>
        <nav class="site-nav">
           <input type="checkbox" id="nav-trigger" class="nav-trigger">
           <label for="nav-trigger">
              <span class="menu-icon">
                 <svg viewbox="0 0 18 15" width="18px" height="15px">
                    <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"></path>
                 </svg>
              </span>
           </label>
           <div class="trigger">
             <!-- Header links -->
              <a class="page-link" target="_blank" href="https://www.youtube.com/thatcsharpguy/">YOUTUBE</a>
              <span class="page-link">
    <div id="google_translate_element" style="display: none;"></div>
    <span class="ct-language">
       <ul class="list-unstyled ct-language-dropdown">
         <li>
            <a href="#" class="lang-select" data-lang="es">
            <img src="https://www.countryflags.io/mx/flat/64.png" title="México">
            </a>
         </li>
          <li>
             <a href="#" class="lang-select" data-lang="en">
             <img src="https://www.countryflags.io/gb/flat/64.png" title="English">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="fr">
             <img src="https://www.countryflags.io/fr/flat/64.png" title="Franch">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="zh-CN">
             <img src="https://www.countryflags.io/cn/flat/64.png" title="Chinese(Simple)">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ja">
             <img src="https://www.countryflags.io/jp/flat/64.png" title="Japan">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ko">
             <img src="https://www.countryflags.io/kr/flat/64.png" title="Korean">
             </a>
          </li>
          <li>
             <a href="#" class="lang-select" data-lang="ru">
             <img src="https://www.countryflags.io/ru/flat/64.png" title="Russia">
             </a>
          </li>
       </ul>
    </span>
    <script type="text/javascript">
       function googleTranslateElementInit() {
         new google.translate.TranslateElement({
           pageLanguage: '',
           autoDisplay: false,
           layout: google.translate.TranslateElement.InlineLayout.VERTICAL
         }, 'google_translate_element');
       
         function restoreLang() {
           var iframe = document.getElementsByClassName('goog-te-banner-frame')[0];
           if (!iframe) return;
       
           var innerDoc = iframe.contentDocument || iframe.contentWindow.document;
           var restore_el = innerDoc.getElementsByTagName("button");
       
           for (var i = 0; i < restore_el.length; i++) {
             if (restore_el[i].id.indexOf("restore") >= 0) {
               restore_el[i].click();
               var close_el = innerDoc.getElementsByClassName("goog-close-link");
               close_el[0].click();
               return;
             }
           }
         }
       
         function triggerHtmlEvent(element, eventName) {
           var event;
           if (document.createEvent) {
             event = document.createEvent('HTMLEvents');
             event.initEvent(eventName, true, true);
             element.dispatchEvent(event);
           } else {
             event = document.createEventObject();
             event.eventType = eventName;
             element.fireEvent('on' + event.eventType, event);
           }
         }
       
         var googleCombo = document.querySelector("select.goog-te-combo");
         var langSelect = document.querySelector('.ct-language');
         langSelect.addEventListener('click', function(event) {
           if (!event.target) {
             return;
           }
       
           var selected = document.querySelector('.ct-language .ct-language-selected');
           if (selected) {
             selected.classList.remove('ct-language-selected');
           }
       
           var target = event.target;
           while (target && target !== langSelect ) {
             if (target.matches('.lang-select')) {
               break;
             }
             target = target.parentElement;
           }
       
           if (target && target.matches('.lang-select')) {
             var lang = target.getAttribute('data-lang');
             if (lang == "es") {
               restoreLang();
             } else {
               target.parentElement.classList.add('ct-language-selected');
               googleCombo.value = lang;
               triggerHtmlEvent(googleCombo, 'change');
             }
           }
       
           event.preventDefault();
         });
       }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
 </span>
           </div>
        </nav>
     </div>
  </div>
</header>
<script>
  (function() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;

      documentElement.setAttribute("data-header-transparent", "");

      var scrollStatus = "";
      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }
      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }
    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });
    storeScrollData();
  })();
</script>
        
        <div class="page-content">
            <div class="wrapper">
                <div class="framework">
                    <section class="main"> 
                        
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="post-content e-content" itemprop="articleBody">
        <h1>Polly-ticas para el manejo de excepciones</h1>
        
<p>En posts pasados hemos <a href="..\excepciones-c-sharp" target="_blank">estado</a> <a href="..\metodos-try" target="_blank">hablando</a> sobr elas excepciones en C#, desde cómo funcionan hasta cómo evitarlas... sin embargo, hay ocasiones en las que llegue a ser absolutamente necesario que la operación que provocó la excepción se repita, ya sea porque es de suma importancia que esta se lleve a cabo o porque el error es solo temporal.</p>
<p>El NuGet del que les voy a hablar hoy nos ayuda a implementar políticas de recuperación ante una falla. Esto es particularmente útil cuando, por ejemplo, estamos consumiendo un servicio web y una petición falla.</p>
<h2 id="policy"><code>Policy</code></h2>
<p>Todo comienza estableciendo una política con la clase <code>Policy</code> a través de su <a href="https://es.wikipedia.org/wiki/Interfaz_fluida" target="_blank">api fluída</a>:</p>
<pre><code class="language-csharp">var politicaReintenta5 = Policy // continúa
</code></pre>
<p>Posteriormente se indica qué errores se tienen que manejar, así que para ello usamos el método <code>Handle</code>:</p>
<pre><code class="language-csharp">    .Handle&lt;ArgumentException&gt;()
</code></pre>
<p>En este caso se está indicando que se quiere manejar las excepciones del tipo <code>ArgumentException</code> (podrías haber especificado en su lugar <code>Exception</code> aunque tal vez no sea lo ideal, como vimos también antes), adicionalmente puedes especificar otras excepciones usando <code>Or</code>:</p>
<pre><code class="language-csharp">    .Or&lt;DivideByZeroException&gt;()
</code></pre>
<p>Para posteriormente indicar la acción que se debe realizar, la más común es la de reintentar <code>Retry</code>:</p>
<pre><code class="language-csharp">    .Retry(5, ReportaError);
</code></pre>
<p>El método <code>Retry</code> permite especificar el número de veces que se debe reintentar la operación (en este caso 5) y un método (<code>ReportaError</code>) que se llamará cada vez que se vaya a reintentar.</p>
<h3 id="el-metodo-reportaerror">El método <code>ReportaError</code></h3>
<p>En este caso, el método recibe la excepción lanzada y el número de intento en el que está. Imprime el número de intento y la hora en la que se está ejecutando:</p>
<pre><code class="language-csharp">static void ReportaError(Exception e, int intentos)
{
    Console.WriteLine($&quot;Intento: {intentos:00}\tTiempo: {DateTime.Now}\nError: {e.Message}&quot;);
}
</code></pre>
<p>Por cierto, no es necesario que especifiques una función, yo lo hice solo para este demo.</p>
<h2 id="ejecutando-la-politica">Ejecutando la política</h2>
<p>Una vez que has decidido ya la política, es momento de ejecutar el código que podría fallar, toma como ejemplo el siguiente método:</p>
<pre><code class="language-csharp">static void LanzaExcepcion()
{
    throw new DivideByZeroException();
}
</code></pre>
<p>Sí, únicamente lanza una excepción, pero podría ser cualquier otra cosa: una conexión a un servicio web, una operación matemática... cualquier cosa.</p>
<p>Entonces para ejecutarlo tomamos la póliza de ejecución (que en realidad es <code>RetryPolicy</code>) y con su método <code>Execute</code>, el cual recibe <a href="..\func-y-action-en-c-sharp" target="_blank">un tipo <code>Action</code></a>, dentro del cual vamos a ejecutar el código &quot;peligroso&quot;:</p>
<pre><code class="language-csharp">try
{
    politicaReintenta5.Execute(() =&gt; 
    { 
        LanzaExcepcion(); 
    });
}
catch(Exception e) 
{ 
    Console.WriteLine($&quot;Después de los intentos, sigue fallando ({e.Message})&quot;);
}
</code></pre>
<p>Oh, por cierto, usando la póliza de <code>Retry</code> (reintentar) no te libras de tener que manejar la excepción tu mismo puesto que al terminar los reintentos, si la acción no se pudo ejecutar la excepción será lanzada como originalmente lo haría. En lo que nos ayuda <em>Polly</em> en este caso es a programar automáticamente los reintentos. Habiendo dicho esto, si ejecutamos el código anterior, esto es lo que obtendremos en la consola:</p>
<pre>
Intento: 01	Tiempo: 6/30/2017 1:37:57 PM
Intento: 02	Tiempo: 6/30/2017 1:37:57 PM
Intento: 03	Tiempo: 6/30/2017 1:37:57 PM
Intento: 04	Tiempo: 6/30/2017 1:37:57 PM
Intento: 05	Tiempo: 6/30/2017 1:37:57 PM
Después de los intentos, sigue fallando (Attempted to divide by zero.)
</pre>
<h2 id="reintentar-esperando-entre-reintentos">Reintentar esperando entre reintentos</h2>
<p>Como puedes ver, los reintentos son inmediatos, pero esto podría no ser siempre lo ideal, ¿si un servicio web no me respondió hace 30 milésimas de segundo, por qué lo hará ahora?</p>
<p>Para estos casos, <em>Polly</em> ofrece la política de <em>&quot;esperar y reintentar&quot;</em>:</p>
<pre><code class="language-csharp">var politicaWaitAndRetry = Policy
    .Handle&lt;DivideByZeroException&gt;()
    .WaitAndRetry(new[]
        {
            TimeSpan.FromSeconds(1),
            TimeSpan.FromSeconds(2),
            TimeSpan.FromSeconds(3)
        }, ReportaError);
</code></pre>
<p>Lo nuevo está a partir del método <code>WaitAndRetry</code>. Este método también tiene diversas sobrecargas, pero una de ellas recibe un arreglo de <code>TimeSpan</code>, que le indica cuánto tiempo debe esperar entre reintentos. En este caso intentará tres veces, esperando 1, 2 y tres segundos entre ellos.</p>
<h3 id="el-metodo-reportarerror">El método <code>ReportarError</code></h3>
<p>En este caso el método que se llama a cada reintento es un poco distinto, recibe la excepción,un <code>TimeSpan</code> indicando el tiempo a esperar, el número de intentos y un objeto del tipo <code>Context</code> que es para usos más avanzados de <em>Polly</em>. Lo que hace es imprimir el número de intento y el tiempo que tardará en realizarse la próxima ejecución:</p>
<pre><code class="language-csharp">static void ReportaError(Exception e, TimeSpan tiempo, int intento, Context contexto)
{
    Console.WriteLine($&quot;Intento: {intento:00} (próximo intento en: {tiempo.Seconds} segundos)\tTiempo: {DateTime.Now}&quot;);
}
</code></pre>
<p>Para hacer uso de la política de nuevo, usamos <code>Execute</code>:</p>
<pre><code class="language-csharp">try
{
    politicaWaitAndRetry.Execute(() =&gt; 
    { 
        LanzaExcepcion(); 
    });
}
catch(Exception e) 
{ 
    Console.WriteLine($&quot;Después de los intentos, sigue fallando ({e.Message})&quot;);
}
</code></pre>
<p>De nueva cuenta, la ejecución está envuelta en un bloque <code>try</code> por si después de todos los intentos el código sigue fallando. El resultado de ejecutar el código es el siguiente:</p>
<pre>
Intento: 01 (próximo intento en: 1 segundos)	Tiempo: 6/30/2017 1:37:57 PM
Intento: 02 (próximo intento en: 2 segundos)	Tiempo: 6/30/2017 1:37:58 PM
Intento: 03 (próximo intento en: 3 segundos)	Tiempo: 6/30/2017 1:38:00 PM
Después de los intentos, sigue fallando (Attempted to divide by zero.)
</pre>  
<p>Una de las prácticas más comunes es la de ir aumentando el tiempo de espera para reintentar una operación de forma exponencial, la forma de implementar esta técnica en <em>Polly</em> es a través de una sobrecarga de <code>WaitAndRetry</code>, que recibe un entero indicando el número de intentos y una <code>Func&lt;int, TimeSpan&gt;</code> para definir el tiempo de espera:</p>
<pre>
Intento: 01 (próximo intento en: 2 segundos)	Tiempo: 6/30/2017 1:38:03 PM
Intento: 02 (próximo intento en: 4 segundos)	Tiempo: 6/30/2017 1:38:05 PM
Intento: 03 (próximo intento en: 8 segundos)	Tiempo: 6/30/2017 1:38:09 PM
Intento: 04 (próximo intento en: 16 segundos)	Tiempo: 6/30/2017 1:38:17 PM
Intento: 05 (próximo intento en: 32 segundos)	Tiempo: 6/30/2017 1:38:33 PM
Después de los intentos, sigue fallando (Attempted to divide by zero.)
</pre>
<h2 id="si-fallla">Si fallla...</h2>
<p>Hasta ahora habíamos tenido que envolver la ejecución en un bloque <code>try</code>, sin embargo, esto se puede evitar utilizando la política de <code>Fallback</code>, esta permite establecer una acción que debe realizarse en caso de que todo falle. Ojo que esta <strong>no es compatible</strong> con la política <code>Retry</code> directamente, se pueden mezclar de otra forma que veremos más adelante.</p>
<p>Ahora vamos a introducir otra modificación, hasta ahora habíamos trabajado con métodos <em>&quot;peligrosos&quot;</em> que no regresaban ningún valor, pero esto no es lo que regularmente harás, las llamadas a servicios web regularmente retornan valores, y es muy probable que eso es lo que quieras hacer en tu código, toma por ejemplo este código, que podría (en este caso siempre) lanzar una excepción pero que idealmente regresa una cadena:</p>
<pre><code class="language-csharp">static string LanzaExcepcionConCadena()
{
    throw new Exception();
    return &quot;Hola&quot;;
}
</code></pre>
<p>Para usarlo junto con una de las políticas de <em>Polly</em> nuevamente hacemos uso de la clase <code>Policy</code>, pero ahora en su <a href="..\genericos-c-sharp-clases" target="_blank">versión genérica</a>:</p>
<pre><code class="language-csharp">var politicaWithFallback = Policy&lt;string&gt;
    .Handle&lt;Exception&gt;()
</code></pre>
<p>Estamos relacionando a nuestra política con el tipo de dato <code>string</code> e indicándole que debe manejar cualquier tipo de <code>Exception</code>, pero lo nuevo es lo siguiente:</p>
<pre><code class="language-csharp">    .Fallback(&quot;Valor de Fallback&quot;);
</code></pre>
<p>El método <code>Fallback</code> indica otra política, una que nos permite establecer un valor por default, en caso de que la ejecución falle. En el código anterior se le indica que la cadena &quot;Valor de Fallback&quot; será devuelta en caso de que la ejecución falle. Entonces podemos llamar a ejecutar el código así:</p>
<pre><code class="language-csharp">var resultado2 = politicaWithFallback.Execute(() =&gt;
{
    return LanzaExcepcionConCadena();
});
Console.WriteLine($&quot;Resultado: {resultado2}&quot;);
</code></pre>
<p>Y obtendremos el siguiente resultado:</p>
<pre>  
Resultado: Valor de Fallback
</pre>
<h2 id="uniendo-politicas">Uniendo políticas</h2>
<p>Pero vamos, que estas políticas son buenas por si mismas, ahora, imagínatelas combinadas... es decir, que tu código intente 5 veces conseguir un valor y si no lo consigue, que tome uno por default. Esto es posible &quot;envolviendo&quot; las políticas mediante el método <code>Wrap</code>:</p>
<pre><code class="language-csharp">var mixedPolicy = Policy.Wrap(politicaWithFallback, politicaWaitAndRetryString);
</code></pre>
<p>Dentro de <code>mixedPolicy</code> están juntas tanto la política de esperar y reintentar como la de asignar un valor por default. Las políticas se ejecutarán de derecha a izquierda, entonces, al ejecutar el siguiente código</p>
<pre><code class="language-csharp">var resultado3 = mixedPolicy.Execute(LanzaExcepcionConCadena);
Console.WriteLine($&quot;Resultado: {resultado3}&quot;);
</code></pre>
<p>En la pantalla se mostrará lo siguiente:</p>
<pre>
Intento: 01 (próximo intento en: 2 segundos)	Tiempo: 6/30/2017 9:33:46 PM
Intento: 02 (próximo intento en: 4 segundos)	Tiempo: 6/30/2017 9:33:48 PM
Intento: 03 (próximo intento en: 8 segundos)	Tiempo: 6/30/2017 9:33:52 PM
Intento: 04 (próximo intento en: 16 segundos)	Tiempo: 6/30/2017 9:34:00 PM
Intento: 05 (próximo intento en: 32 segundos)	Tiempo: 6/30/2017 9:34:16 PM
Resultado: Valor de Fallback
</pre>
<h2 id="mas-caracteristicas">Más características</h2>
<p>Esta biblioteca tiene más características que no cubrí en este post, te invito a que descargues <a href="https://github.com/ThatCSharpGuy/polly-sample" target="_blank">el código de ejemplo</a> de este post para que pruebes todas las posibilidades.</p>
<h2 id="uso">Uso</h2>
<p>Puedes acceder a <em>Polly</em> a través de este <a href="https://www.nuget.org/packages/polly" target="_blank">paquete de NuGet</a>.</p>
<pre><code>PM&gt; Install-Package Polly
</code></pre>
<p><em>Polly</em> es parte de la .NET Foundation, y su código está <a href="https://github.com/App-vNext/Polly" target="_blank">disponible en GitHub</a>, puedes ver cómo está hecho y contribuir a mejorarlo.</p>


    </div>
</article>

                    </section>
                    <section class="sidebar">
                        <div class="theme-toggle">
  <input type="checkbox" id="theme-switch"/>
  <label for="theme-switch">
      <div class="toggle"></div>
      <div class="names">
          <p class="light">Light</p>
          <p class="dark">Dark</p>
      </div>
  </label>
</div>
  


<script>
    (function() {
      var sw = document.getElementById('theme-switch');
      var html = document.getElementsByTagName('html')[0];
      var nightModeOption = ('auto' || 'auto').toLowerCase();
      var storage = nightModeOption === 'manual'
          ? localStorage
          : sessionStorage;
      var themeData = loadThemeData();
  
      function saveThemeData(data) {
        storage.setItem('theme', JSON.stringify(data));
      }
  
      function loadThemeData() {
        var data = storage.getItem('theme');
        try {
          data = JSON.parse(data ? data : '');
        } catch(e) {
          data = { nightShift: undefined, autoToggleAt: 0 };
          saveThemeData(data);
        }
        return data;
      }
  
      function handleThemeToggle(nightShift) {
        themeData.nightShift = nightShift;
        saveThemeData(themeData);
        html.dataset.theme = nightShift ? 'dark' : 'light';
        setTimeout(function() {
          sw.checked = nightShift ? true : false;
        }, 50);
      }
  
      function autoThemeToggle() {
        // Next time point of theme toggle
        var now = new Date();
        var toggleAt = new Date();
        var hours = now.getHours();
        var nightShift = hours >= 19 || hours <=7;
  
        if (nightShift) {
          if (hours > 7) {
            toggleAt.setDate(toggleAt.getDate() + 1);
          }
          toggleAt.setHours(7);
        } else {
          toggleAt.setHours(19);
        }
  
        toggleAt.setMinutes(0);
        toggleAt.setSeconds(0);
        toggleAt.setMilliseconds(0)
  
        var delay = toggleAt.getTime() - now.getTime();
  
        // auto toggle theme mode
        setTimeout(function() {
          handleThemeToggle(!nightShift);
        }, delay);
  
        return {
          nightShift: nightShift,
          toggleAt: toggleAt.getTime()
        };
      }
  
      // Listen the theme toggle event
      sw.addEventListener('change', function(event) {
        handleThemeToggle(event.target.checked);
      });
  
      if (nightModeOption == 'auto') {
        var data = autoThemeToggle();
  
        // Toggle theme by local setting
        if (data.toggleAt > themeData.autoToggleAt) {
          themeData.autoToggleAt = data.toggleAt;
          handleThemeToggle(data.nightShift);
        } else {
          handleThemeToggle(themeData.nightShift);
        }
      } else if (nightModeOption == 'manual') {
        handleThemeToggle(themeData.nightShift);
      } else {
        var nightShift = themeData.nightShift;
        if (nightShift === undefined) {
          nightShift = nightModeOption === 'on';
        }
        handleThemeToggle(nightShift);
      }
    })();
  </script>
                        <div class="post-menu">
                            <div class="post-menu-title">Sígueme en</div>
                            <div class="common-list">
                                <ul>
                                    
                                    <li>
                                        <a href="https://github.com/fferegrino">GitHub<span><i class="fab fa-github"></i></span></a>
                                    </li>
                                    
                                    <li>
                                        <a href="https://twitter.com/io_exception">Twitter<span><i class="fab fa-twitter"></i></span></a>
                                    </li>
                                    
                                    <li>
                                        <a href="https://youtube.com/thatcsharpguy">YouTube<span><i class="fab fa-youtube"></i></span></a>
                                    </li>
                                    
                                    <li>
                                        <a href="https://tcsg.dev/discord">Discord<span><i class="fab fa-discord"></i></span></a>
                                    </li>
                                    
                                </ul>
                            </div>
                        </div>
                        
 <style type="text/css" media="screen">
    .post-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }
</style>
<div class="post-menu toc">
    <div class="post-menu-title">TOC</div>
    <div class="post-menu-content"></div>
</div>
<script>
    function generateContent() {
        var menu = document.querySelector(".post-menu.toc");
        console.log(menu);
        var menuContent = menu.querySelector(".post-menu-content");
        var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");
        // Hide menu when no headings
        if (headings.length === 0) {
            return menu.style.display = "none";
        }
        // Generate post menu
        var menuHTML = '';
        for (var i = 0; i < headings.length; i++) {
            var h = headings[i];
            menuHTML += ('<li class="h-' + h.tagName.toLowerCase() + '">' + '<a href="#' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
        }
        menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';
        // The header element
        var header = document.querySelector('header.site-header');
        function doMenuCollapse(index, over_items) {
            var items = menuContent.firstChild.children;
            if (over_items == undefined) {
                over_items = 20;
            }
            if (items.length<over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0 && ! items[beginIndex].classList.contains('h-h2')) {
                beginIndex -= 1;
            }
            while (endIndex < items.length && ! items[endIndex].classList.contains('h-h2')) {
                endIndex += 1;
            }
            for (var i = 0; i < beginIndex; i++) {
                item = items[i]
                if (!item.classList.contains('h-h2')) {
                    item.style.display = 'none';
                }
            }
            for (var i = beginIndex + 1; i < endIndex; i++) {
                item = items[i]
                // if (!item.classList.contains('h-h2')) {
                item.style.display = '';
                // }
            }
            for (var i = endIndex; i < items.length; i++) {
                item = items[i]
                if (!item.classList.contains('h-h2')) {
                    item.style.display = 'none';
                }
            }
        }
        // Init menu collapsed
        doMenuCollapse(-1);
        // Active the menu item
        window.addEventListener('scroll', function (event) {
            var lastActive = menuContent.querySelector('.active');
            var changed = true;
            var activeIndex = -1;
            for (var i = headings.length - 1; i >= 0; i--) {
                var h = headings[i];
                var headingRect = h.getBoundingClientRect();
                var headerRect = header.getBoundingClientRect();
                var headerTop = Math.floor(headerRect.top);
                var headerHeight = Math.floor(headerRect.height);
                var headerHeight = headerTop + headerHeight + 20;
                if (headingRect.top <= headerHeight) {
                    var id = 'h-' + h.getAttribute('id');
                    var a = menuContent.querySelector('a[href="#' + id + '"]');
                    var curActive = a.parentNode;
                    if (curActive) {
                        curActive.classList.add('active');
                        activeIndex = i;
                    }
                    if (lastActive == curActive) {
                        changed = false;
                    }
                    break;
                }
            }
            if (changed) {
                if (lastActive) {
                    lastActive.classList.remove('active');
                }
                doMenuCollapse(activeIndex);
            }
            event.preventDefault();
        });
    }
    document.addEventListener("DOMContentLoaded", function() {
        generateContent()
    });
</script>

                    </section>
                </div>
            </div>
        </div>
        <footer class="site-footer h-card">
   <data class="u-url" href="/"></data>
 
   <div class="wrapper">
     <div class="site-footer-inner">
       <div> </div>
       <div>Powered by <a title="Lockdonw in a simple, blog-aware, static site generator." href="https://github.com/lockdownblog/lockdown">Lockdown</a> &amp; <a title="Yat, yetanother theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
       <!-- <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></div> -->
     </div>
   </div>
 </footer>
    </body>
</html>